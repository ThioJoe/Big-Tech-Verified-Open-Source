<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verified Repos Data Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* GitHub-like Markdown Styles for Preview */
        .markdown-body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji"; font-size: 14px; line-height: 1.5; color: #24292f; }
        .markdown-body table { border-spacing: 0; border-collapse: collapse; width: 100%; margin-top: 0; margin-bottom: 16px; display: block; width: max-content; max-width: 100%; overflow: auto; }
        .markdown-body tr { background-color: #ffffff; border-top: 1px solid #d0d7de; }
        .markdown-body tr:nth-child(2n) { background-color: #f6f8fa; }
        .markdown-body td, .markdown-body th { padding: 6px 13px; border: 1px solid #d0d7de; }
        .markdown-body th { font-weight: 600; }
        .markdown-body a { color: #0969da; text-decoration: none; }
        .markdown-body a:hover { text-decoration: underline; }
        .markdown-body code { padding: 0.2em 0.4em; margin: 0; font-size: 85%; background-color: rgba(175,184,193,0.2); border-radius: 6px; font-family: ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace; }
        .markdown-body h2 { border-bottom: 1px solid #d0d7de; padding-bottom: 0.3em; font-size: 1.5em; font-weight: 600; margin-top: 24px; margin-bottom: 16px; }

        /* Drag and Drop Styles */
        .drag-over { border-top: 2px solid #3b82f6 !important; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Top Bar -->
    <header class="bg-gray-800 text-white p-4 flex justify-between items-center shadow-md z-10">
        <div class="flex items-center gap-3">
            <h1 class="font-bold text-xl"><i class="fa-solid fa-database mr-2"></i>Data Manager</h1>
            <span class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300">Verified_Repos_Data.json</span>
        </div>
        <div class="flex gap-2">
            <button onclick="document.getElementById('fileInput').click()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-sm transition font-medium">
                <i class="fa-solid fa-folder-open mr-2"></i>Load File
            </button>
            <input type="file" id="fileInput" class="hidden" accept=".json" onchange="handleFileUpload(this)">
            <button onclick="copyOutput()" id="copyBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-sm transition font-medium shadow-sm">
                <i class="fa-solid fa-copy mr-2"></i>Copy JSON
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-grow flex overflow-hidden">
        
        <!-- Left Sidebar: Tree View -->
        <div class="w-1/3 min-w-[300px] bg-white border-r border-gray-200 flex flex-col">
            <div class="p-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                <h2 class="font-bold text-gray-700 text-sm">Companies & Accounts</h2>
                <button onclick="addCompany()" class="text-xs bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded transition">
                    <i class="fa-solid fa-plus mr-1"></i>New Company
                </button>
            </div>
            <div id="treeContainer" class="flex-grow overflow-y-auto p-2 space-y-1">
                <!-- Tree items injected here -->
            </div>
        </div>

        <!-- Right Panel: Editor -->
        <div class="w-2/3 flex flex-col bg-gray-50">
            <!-- Empty State -->
            <div id="emptyState" class="flex-grow flex flex-col items-center justify-center text-gray-400">
                <i class="fa-regular fa-hand-point-left text-4xl mb-4"></i>
                <p>Select an item on the left to edit</p>
            </div>

            <!-- Editor Form Container -->
            <div id="editorContainer" class="hidden flex-col h-full overflow-hidden">
                <div id="editorHeader" class="bg-white border-b border-gray-200 p-4 shadow-sm flex justify-between items-center flex-shrink-0">
                    <h2 id="editorTitle" class="font-bold text-lg text-gray-800">Edit</h2>
                    <button onclick="deleteCurrentItem()" class="text-red-500 hover:text-red-700 text-sm font-medium">
                        <i class="fa-solid fa-trash-can mr-1"></i>Delete
                    </button>
                </div>
                
                <!-- Scrollable Form Area -->
                <div id="formContent" class="flex-grow overflow-y-auto p-6 space-y-6">
                    <!-- Dynamic form injected here -->
                </div>

                <!-- Preview Pane (Fixed at Bottom) -->
                <div class="bg-white border-t border-gray-300 flex-shrink-0 h-64 flex flex-col shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                    <div class="flex justify-between items-center px-4 py-2 bg-gray-100 border-b border-gray-200">
                        <span class="text-xs font-bold uppercase tracking-wider text-gray-600"><i class="fa-brands fa-markdown mr-1"></i> Live Preview</span>
                    </div>
                    <!-- Rendered HTML goes here -->
                    <div id="livePreview" class="markdown-body flex-grow overflow-y-auto p-4 bg-white"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Raw JSON Modal (Hidden by default, used for export) -->
    <textarea id="jsonOutput" class="hidden"></textarea>

    <script>
        // --- State Management ---
        let db = { companies: [] };
        let selectedPath = null; // { type: 'company', index: 0 } or { type: 'account', cIndex: 0, aIndex: 0 }

        // --- Initialization ---
        window.onload = function() {
            renderTree();
        };

        // --- File Handling ---
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (!json.companies || !Array.isArray(json.companies)) throw new Error("Invalid schema");
                    db = json;
                    selectedPath = null;
                    renderTree();
                    showEmptyState();
                } catch (err) {
                    alert("Error loading JSON: " + err.message);
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset
        }

        function copyOutput() {
            const output = JSON.stringify(db, null, 2);
            navigator.clipboard.writeText(output).then(() => {
                const btn = document.getElementById('copyBtn');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>Copied!';
                btn.classList.replace('bg-green-600', 'bg-gray-700');
                btn.classList.replace('hover:bg-green-700', 'hover:bg-gray-600');
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.replace('bg-gray-700', 'bg-green-600');
                    btn.classList.replace('hover:bg-gray-600', 'hover:bg-green-700');
                }, 2000);
            });
        }

        // --- Rendering: Tree View ---
        function renderTree() {
            const container = document.getElementById('treeContainer');
            container.innerHTML = '';

            db.companies.forEach((company, cIndex) => {
                // Company Item
                const compDiv = document.createElement('div');
                const isCompSelected = selectedPath && selectedPath.type === 'company' && selectedPath.index === cIndex;
                
                compDiv.className = `group`;
                
                // Company Header
                const header = document.createElement('div');
                header.className = `flex items-center p-2 rounded cursor-pointer transition ${isCompSelected ? 'bg-blue-100 text-blue-800 font-bold' : 'hover:bg-gray-100 text-gray-700'}`;
                header.onclick = () => selectCompany(cIndex);
                header.innerHTML = `
                    <i class="fa-solid fa-building mr-2 text-gray-400 ${isCompSelected ? 'text-blue-500' : ''}"></i>
                    <span class="truncate flex-grow">${escapeHtml(company.name || 'Unnamed Company')}</span>
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition mr-2">
                        <button onclick="event.stopPropagation(); moveCompany(${cIndex}, -1)" class="p-1 hover:bg-gray-200 rounded text-gray-500" title="Move Up"><i class="fa-solid fa-arrow-up text-xs"></i></button>
                        <button onclick="event.stopPropagation(); moveCompany(${cIndex}, 1)" class="p-1 hover:bg-gray-200 rounded text-gray-500" title="Move Down"><i class="fa-solid fa-arrow-down text-xs"></i></button>
                    </div>
                    <button onclick="event.stopPropagation(); addAccount(${cIndex})" class="opacity-0 group-hover:opacity-100 text-xs bg-gray-200 hover:bg-gray-300 px-1.5 py-0.5 rounded text-gray-600" title="Add Account">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                `;
                compDiv.appendChild(header);

                // Accounts List
                if (company.accounts && company.accounts.length > 0) {
                    const accList = document.createElement('div');
                    accList.className = "ml-6 border-l-2 border-gray-100 pl-1 mt-1 space-y-1";
                    
                    company.accounts.forEach((acc, aIndex) => {
                        const accDiv = document.createElement('div');
                        const isAccSelected = selectedPath && selectedPath.type === 'account' && selectedPath.cIndex === cIndex && selectedPath.aIndex === aIndex;
                        
                        // Drag and Drop Attributes
                        accDiv.setAttribute('draggable', 'true');
                        accDiv.ondragstart = (e) => dragStart(e, cIndex, aIndex);
                        accDiv.ondragover = (e) => dragOver(e);
                        accDiv.ondrop = (e) => drop(e, cIndex, aIndex);
                        accDiv.ondragleave = (e) => dragLeave(e);

                        accDiv.className = `flex items-center p-1.5 rounded cursor-pointer text-sm transition border border-transparent ${isAccSelected ? 'bg-blue-50 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-100'}`;
                        accDiv.onclick = (e) => { e.stopPropagation(); selectAccount(cIndex, aIndex); };
                        
                        let inner = `
                            <i class="fa-brands fa-github mr-2 ${isAccSelected ? 'text-blue-500' : 'text-gray-400'}"></i>
                            <span class="truncate mr-2">${escapeHtml(acc.name || 'Unnamed Account')}</span>
                        `;

                        // Verified Tag
                        if (acc.verified_domain) {
                            inner += `<span class="ml-auto text-[10px] bg-green-50 text-green-700 px-1.5 py-0.5 rounded border border-green-200 flex-shrink-0" title="Verified Domain"><i class="fa-solid fa-check mr-1"></i>${escapeHtml(acc.verified_domain)}</span>`;
                        }

                        accDiv.innerHTML = inner;
                        accList.appendChild(accDiv);
                    });
                    compDiv.appendChild(accList);
                }

                container.appendChild(compDiv);
            });
        }

        // --- Drag and Drop Logic ---
        function dragStart(e, cIndex, aIndex) {
            e.dataTransfer.setData("application/json", JSON.stringify({cIndex, aIndex}));
            e.dataTransfer.effectAllowed = "move";
        }

        function dragOver(e) {
            e.preventDefault(); // Necessary to allow dropping
            e.dataTransfer.dropEffect = "move";
            e.currentTarget.classList.add("drag-over");
        }

        function dragLeave(e) {
            e.currentTarget.classList.remove("drag-over");
        }

        function drop(e, targetCIndex, targetAIndex) {
            e.preventDefault();
            e.currentTarget.classList.remove("drag-over");

            const data = JSON.parse(e.dataTransfer.getData("application/json"));
            const srcCIndex = data.cIndex;
            const srcAIndex = data.aIndex;

            // Only allow dragging within the same company for simplicity (as requested "entries within a company")
            if (srcCIndex !== targetCIndex) return;
            if (srcAIndex === targetAIndex) return;

            // Perform the move
            const accounts = db.companies[srcCIndex].accounts;
            const [movedItem] = accounts.splice(srcAIndex, 1);
            accounts.splice(targetAIndex, 0, movedItem);

            // Update Selection if we moved the currently selected item
            if (selectedPath && selectedPath.type === 'account' && selectedPath.cIndex === srcCIndex) {
                if (selectedPath.aIndex === srcAIndex) {
                    selectedPath.aIndex = targetAIndex;
                } else if (srcAIndex < selectedPath.aIndex && targetAIndex >= selectedPath.aIndex) {
                    selectedPath.aIndex--;
                } else if (srcAIndex > selectedPath.aIndex && targetAIndex <= selectedPath.aIndex) {
                    selectedPath.aIndex++;
                }
            }

            renderTree();
        }

        // --- Reordering Logic ---
        function moveCompany(index, direction) {
            if (index + direction < 0 || index + direction >= db.companies.length) return;
            
            const temp = db.companies[index];
            db.companies[index] = db.companies[index + direction];
            db.companies[index + direction] = temp;

            // Update Selection Tracking
            if (selectedPath) {
                if (selectedPath.type === 'company') {
                    if (selectedPath.index === index) selectedPath.index += direction;
                    else if (selectedPath.index === index + direction) selectedPath.index -= direction;
                } else {
                    if (selectedPath.cIndex === index) selectedPath.cIndex += direction;
                    else if (selectedPath.cIndex === index + direction) selectedPath.cIndex -= direction;
                }
            }

            renderTree();
        }


        // --- Selection Logic ---
        function selectCompany(index) {
            selectedPath = { type: 'company', index };
            renderTree();
            renderEditor();
        }

        function selectAccount(cIndex, aIndex) {
            selectedPath = { type: 'account', cIndex, aIndex };
            renderTree();
            renderEditor();
        }

        function showEmptyState() {
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('editorContainer').classList.add('hidden');
        }

        // --- CRUD Logic ---
        function addCompany() {
            db.companies.push({ name: "New Company", accounts: [] });
            selectCompany(db.companies.length - 1);
        }

        function addAccount(cIndex) {
            if (!db.companies[cIndex].accounts) db.companies[cIndex].accounts = [];
            db.companies[cIndex].accounts.push({
                name: "New Account",
                github_url: "https://github.com/",
                verified_domain: null,
                proof_steps: []
            });
            selectAccount(cIndex, db.companies[cIndex].accounts.length - 1);
        }

        function deleteCurrentItem() {
            if (!selectedPath) return;
            if (!confirm("Are you sure you want to delete this item?")) return;

            if (selectedPath.type === 'company') {
                db.companies.splice(selectedPath.index, 1);
                selectedPath = null;
            } else {
                db.companies[selectedPath.cIndex].accounts.splice(selectedPath.aIndex, 1);
                selectedPath = { type: 'company', index: selectedPath.cIndex };
            }
            renderTree();
            if(selectedPath) renderEditor(); else showEmptyState();
        }

        // --- Rendering: Editor Forms ---
        function renderEditor() {
            if (!selectedPath) { showEmptyState(); return; }

            document.getElementById('emptyState').classList.add('hidden');
            const container = document.getElementById('editorContainer');
            container.classList.remove('hidden');
            container.classList.add('flex');
            
            const formContent = document.getElementById('formContent');
            formContent.innerHTML = '';

            if (selectedPath.type === 'company') {
                renderCompanyForm(formContent);
            } else {
                renderAccountForm(formContent);
            }
            
            renderPreview(); // Update preview initially
        }

        function renderCompanyForm(container) {
            const company = db.companies[selectedPath.index];
            document.getElementById('editorTitle').textContent = "Edit Company";

            // Name Field
            container.innerHTML = `
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-gray-700">Company Name</label>
                    <input type="text" value="${escapeHtml(company.name)}" oninput="updateCompany('name', this.value)" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>
            `;
        }

        function renderAccountForm(container) {
            const account = db.companies[selectedPath.cIndex].accounts[selectedPath.aIndex];
            document.getElementById('editorTitle').textContent = `Edit Account: ${account.name}`;

            // Basic Fields
            let html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="block text-xs font-bold uppercase text-gray-500">Display Name</label>
                        <input type="text" value="${escapeHtml(account.name)}" oninput="updateAccount('name', this.value)" class="w-full p-2 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="space-y-1">
                        <label class="block text-xs font-bold uppercase text-gray-500">GitHub URL</label>
                        <input type="text" value="${escapeHtml(account.github_url)}" oninput="updateAccount('github_url', this.value)" class="w-full p-2 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div class="space-y-1 pt-2">
                    <label class="block text-xs font-bold uppercase text-gray-500">Verified Domain</label>
                    <div class="flex gap-2">
                        <input type="text" id="verifiedDomainInput" value="${escapeHtml(account.verified_domain || '')}" 
                            ${account.verified_domain === null ? 'disabled' : ''}
                            oninput="updateAccount('verified_domain', this.value)" 
                            class="flex-grow p-2 border border-gray-300 rounded disabled:bg-gray-100 disabled:text-gray-400 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="e.g. google.com">
                        <div class="flex items-center">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600" 
                                    ${account.verified_domain !== null ? 'checked' : ''} 
                                    onchange="toggleVerifiedDomain(this.checked)">
                                <span class="ml-2 text-sm text-gray-700">Verified?</span>
                            </label>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500">Uncheck if the account has no green "Verified" badge on GitHub.</p>
                </div>

                <hr class="border-gray-200">

                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <label class="block text-sm font-bold text-gray-800">Proof Steps</label>
                        <button onclick="addStep()" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded transition shadow-sm">
                            <i class="fa-solid fa-plus mr-1"></i>Add Step
                        </button>
                    </div>
                    <div id="stepsList" class="space-y-4">
                        <!-- Steps injected here -->
                    </div>
                </div>
            `;
            container.innerHTML = html;
            renderSteps(account.proof_steps);
        }

        // --- Data Updates ---
        function updateCompany(field, value) {
            db.companies[selectedPath.index][field] = value;
            renderTree();
            renderPreview();
        }

        function updateAccount(field, value) {
            db.companies[selectedPath.cIndex].accounts[selectedPath.aIndex][field] = value;
            if (field === 'name') renderTree();
            renderPreview();
        }

        function toggleVerifiedDomain(isChecked) {
            const acc = db.companies[selectedPath.cIndex].accounts[selectedPath.aIndex];
            if (isChecked) {
                acc.verified_domain = "";
                document.getElementById('verifiedDomainInput').disabled = false;
                document.getElementById('verifiedDomainInput').focus();
            } else {
                acc.verified_domain = null;
                document.getElementById('verifiedDomainInput').value = "";
                document.getElementById('verifiedDomainInput').disabled = true;
            }
            renderPreview();
            renderTree(); // Update tag in tree
        }

        // --- Steps Logic ---
        function addStep() {
            const steps = db.companies[selectedPath.cIndex].accounts[selectedPath.aIndex].proof_steps;
            steps.push({ type: "Base", text: "", url: null });
            renderEditor(); 
        }

        function removeStep(index) {
            const steps = db.companies[selectedPath.cIndex].accounts[selectedPath.aIndex].proof_steps;
            steps.splice(index, 1);
            renderEditor();
        }

        function moveStep(index, direction) {
            const steps = db.companies[selectedPath.cIndex].accounts[selectedPath.aIndex].proof_steps;
            if (index + direction < 0 || index + direction >= steps.length) return;
            const temp = steps[index];
            steps[index] = steps[index + direction];
            steps[index + direction] = temp;
            renderEditor();
        }

        function updateStep(stepIndex, field, value) {
            const step = db.companies[selectedPath.cIndex].accounts[selectedPath.aIndex].proof_steps[stepIndex];
            
            if ((field === 'url' || field === 'archive_url') && value.trim() === '') {
                step[field] = null;
            } else {
                step[field] = value;
            }

            if (field === 'type') {
                if (value === 'Base' || value === 'StandaloneHyperlink') delete step.prefix_text;
                if (value === 'Base' || value === 'LinksTo' || value === 'RedirectsTo') {
                    if(step.url === undefined) step.url = null;
                }
                renderEditor(); 
            } else {
                renderPreview();
            }
        }

        function renderSteps(steps) {
            const container = document.getElementById('stepsList');
            container.innerHTML = '';
            
            if (!steps || steps.length === 0) {
                container.innerHTML = '<div class="text-center p-4 bg-gray-100 rounded text-gray-400 text-sm italic">No proof steps defined yet.</div>';
                return;
            }

            steps.forEach((step, index) => {
                const el = document.createElement('div');
                el.className = "bg-white border border-gray-200 rounded-lg p-3 shadow-sm relative group hover:border-blue-300 transition";
                
                let html = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded-full border border-gray-200">#${index + 1}</span>
                            <select onchange="updateStep(${index}, 'type', this.value)" class="text-sm border-gray-300 rounded border p-1 font-semibold text-blue-700 bg-blue-50 focus:ring-blue-500 focus:outline-none">
                                <option value="Base" ${step.type === 'Base' ? 'selected' : ''}>Base</option>
                                <option value="StandaloneHyperlink" ${step.type === 'StandaloneHyperlink' ? 'selected' : ''}>StandaloneHyperlink</option>
                                <option value="LinksTo" ${step.type === 'LinksTo' ? 'selected' : ''}>LinksTo (ðŸ Š)</option>
                                <option value="RedirectsTo" ${step.type === 'RedirectsTo' ? 'selected' : ''}>RedirectsTo (ðŸ Š)</option>
                            </select>
                        </div>
                        <div class="flex gap-1 opacity-50 group-hover:opacity-100 transition">
                            <button onclick="moveStep(${index}, -1)" class="p-1 hover:bg-gray-100 rounded" title="Move Up"><i class="fa-solid fa-arrow-up text-gray-500"></i></button>
                            <button onclick="moveStep(${index}, 1)" class="p-1 hover:bg-gray-100 rounded" title="Move Down"><i class="fa-solid fa-arrow-down text-gray-500"></i></button>
                            <button onclick="removeStep(${index})" class="p-1 hover:bg-red-100 rounded text-red-500 ml-1" title="Delete Step"><i class="fa-solid fa-times"></i></button>
                        </div>
                    </div>
                `;

                html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">`;

                if (step.type === 'LinksTo' || step.type === 'RedirectsTo') {
                    html += `
                        <div class="col-span-1 md:col-span-2">
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Prefix Text (Optional)</label>
                            <input type="text" value="${escapeHtml(step.prefix_text || '')}" oninput="updateStep(${index}, 'prefix_text', this.value)" class="w-full text-sm p-1.5 border border-gray-300 rounded focus:border-blue-500" placeholder='e.g. "Follow Us" button'>
                        </div>
                    `;
                }

                html += `
                    <div class="col-span-1 ${step.type === 'StandaloneHyperlink' ? '' : 'md:col-span-2'}">
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Text (Displayed Label)</label>
                        <input type="text" value="${escapeHtml(step.text || '')}" oninput="updateStep(${index}, 'text', this.value)" class="w-full text-sm p-1.5 border border-gray-300 rounded focus:border-blue-500" placeholder="e.g. google.com">
                    </div>
                `;

                html += `
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Destination URL ${step.type !== 'StandaloneHyperlink' ? '(Optional)' : '(Required)'}</label>
                        <input type="text" value="${escapeHtml(step.url || '')}" oninput="updateStep(${index}, 'url', this.value)" class="w-full text-sm p-1.5 border border-gray-300 rounded focus:border-blue-500 text-blue-600 font-mono" placeholder="https://...">
                    </div>
                `;

                html += `
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Archive URL (Wayback Machine)</label>
                        <input type="text" value="${escapeHtml(step.archive_url || '')}" oninput="updateStep(${index}, 'archive_url', this.value)" class="w-full text-sm p-1.5 border border-gray-300 rounded focus:border-blue-500 text-gray-600 font-mono" placeholder="https://web.archive.org/...">
                    </div>
                `;

                html += `</div>`; 
                el.innerHTML = html;
                container.appendChild(el);
            });
        }

        // --- Preview Logic ---
        function renderPreview() {
            if (!selectedPath) return;

            const previewEl = document.getElementById('livePreview');
            let md = "";

            if (selectedPath.type === 'company') {
                const company = db.companies[selectedPath.index];
                md += `## ${company.name || "Company Name"}\n\n`;
                md += "| Organization/Account | Verified Domain | Proof of Association |\n";
                md += "|---|---|---|\n";
                if (company.accounts) {
                    company.accounts.forEach(acc => {
                        md += generateRowMarkdown(acc) + "\n";
                    });
                }
            } else {
                const company = db.companies[selectedPath.cIndex];
                const account = company.accounts[selectedPath.aIndex];
                // Show header for context
                md += "| Organization/Account | Verified Domain | Proof of Association |\n";
                md += "|---|---|---|\n";
                md += generateRowMarkdown(account);
            }
            
            // Render Markdown to HTML using Marked.js
            previewEl.innerHTML = marked.parse(md);
        }

        // Helper: Formatting logic ported from Readme_Generator.html
        function formatLabel(text) {
            if (!text) return "";
            if (text.startsWith('`') && text.endsWith('`')) return text;
            if (!text.includes(' ') && text.includes('.')) return `\`${text}\``;
            return text;
        }

        function generateRowMarkdown(account) {
            // 1. Column: Organization
            const col1 = `**[${account.name}](${account.github_url})**`;

            // 2. Column: Verified Domain
            const col2 = account.verified_domain ? `\`${account.verified_domain}\`` : "";

            // 3. Column: Proof
            let col3 = "";
            if (account.proof_steps && Array.isArray(account.proof_steps)) {
                col3 = account.proof_steps.map((step, index) => {
                    let line = "";
                    
                    if (index > 0) line += "<br>â†³ ";

                    const archivePart = step.archive_url ? `<sup> [[A]](${step.archive_url})</sup>` : "";

                    if (step.type === "Base") {
                        const label = formatLabel(step.text);
                        line += step.url ? `[${label}](${step.url})` : label;
                        line += archivePart;
                    } 
                    else if (step.type === "StandaloneHyperlink") {
                        const label = formatLabel(step.text);
                        line += `[${label}](${step.url})`;
                        line += archivePart;
                    }
                    else if (step.type === "LinksTo" || step.type === "RedirectsTo") {
                        const arrow = "ðŸ Š"; 
                        const actionText = step.type === "LinksTo" ? "Links To" : "Redirects To";
                        
                        if (step.prefix_text) line += `${step.prefix_text} `;
                        line += `${actionText} ${arrow} `;
                        
                        const label = formatLabel(step.text);
                        line += step.url ? `[${label}](${step.url})` : label;
                        line += archivePart;
                    }
                    return line;
                }).join("");
            }

            // Align table cells
            const cells = [col1, col2, col3].map(c => c ? ` ${c} ` : " ");
            return `|${cells.join("|")}|`;
        }

        // --- Utility ---
        function escapeHtml(text) {
            if (text === null || text === undefined) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

    </script>
</body>
</html>